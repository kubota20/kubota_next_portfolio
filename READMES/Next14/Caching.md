# キャッシュについて

## キャッシングメカニズム

| メカニズム           | 内容                       | 場所         | 目的                                                 | 期間                               |
| -------------------- | -------------------------- | ------------ | ---------------------------------------------------- | ---------------------------------- |
| リクエストメモ化     | 関数の返り値               | サーバ       | React コンポーネントツリー内でデータを再利用         | リクエストごとのライフサイクル     |
| データキャッシュ     | データ                     | サーバ       | ユーザーのリクエストやデプロイメント間でデータを保存 | 永続的（再検証可能）               |
| フルルートキャッシュ | HTML および RSC ペイロード | サーバ       | レンダリングコストを削減しパフォーマンスを向上       | 永続的（再検証可能）               |
| ルーターキャッシュ   | RSC ペイロード             | クライアント | ナビゲーション時のサーバリクエストを削減             | ユーザーセッションまたは時間ベース |

## Revalidating (再検証中)

キャッシュされたデータは２つある

- `時間ベースの再検証`: 定の時間が経過し、新しいリクエストが行われた後にデータを再検証します。これは、`頻繁に変更されず、鮮度がそれほど重要ではない`データに役立ちます。

- `オンデマンド再検証`: `イベント (フォームの送信など)` に基づいてデータを再検証します。タグベースまたはパスベースで使用して、データのグループを一度に再検証できます。`最新のデータができるだけ早く表示されるようにしたい場合 (ヘッドレス CMS のコンテンツが更新された場合など)` に便利です。

### Time-based Revalidation (時間ベースの再検証)

キャッシュ有効期間 (秒単位) を設定できます

```

fetch('https://...', { next: { revalidate: 3600 } })

```

### On-demand Revalidation (オンデマンド再検証)

`revalidatePath`を使ってデータを手動で再検証します。
特定のパスの下のルート セグメントを 1 回の操作で再レンダリングできます。
`revalidatePathメソッド`を呼び出すと、データ キャッシュが再検証され、フルルートキャッシュが無効になります

```

revalidatePath('/')

```

#### 使用方法

使用場所は２つあります

1, `Route handlers` Webhook などでデータを再検証します。

2, `Server Actions` ユーザーの操作 (フォームの送信、ボタンのクリックなど) 後にデータを再検証します。

[revalidatePath API](https://nextjs.org/docs/app/api-reference/functions/revalidatePath)で確認

### オプトアウト

`cache`での個々のデータ取得について、`no-store`で`fetch`が呼び出されるたびにデータが取得されます。

```

fetch(`https://...`, { cache: 'no-store' })

```

`注意`: データ キャッシュはページ/ルートでのみ利用可能であり、ミドルウェアでは利用できません。ミドルウェア内で行われるフェッチはデフォルトではキャッシュされません。

## Full Route Cache (フルルートキャッシュ)

Next.js ではフルルートキャッシュが使われています。違いは React レンダリングでわかります。

- _React_: `React Server Component Payload`と呼ばれるストリーミング用に最適化された特別なデータ形式にレンダリングします。

- _Next_: `React Server Component Payload`と`Client Component` 使用して、`サーバー上でHTML をレンダリング`します。

Next.js の方が時間がかかるように見えるが、作業をキャッシュしたり応答を送信したりする前に、すべてがレンダリングされるのを待つ必要はありません。代わりに、作業が完了すると応答をストリーミングできます。

## キャッシュメカニズムと関連 API

| API                             | ルーターキャッシュ          | フルルートキャッシュ         | データキャッシュ             | リアクトキャッシュ |
| ------------------------------- | --------------------------- | ---------------------------- | ---------------------------- | ------------------ |
| `<Link prefetch>`               | キャッシュ                  |                              |                              |                    |
| `router.prefetch`               | キャッシュ                  |                              |                              |                    |
| `router.refresh`                | 再検証                      |                              |                              |                    |
| `fetch`                         |                             |                              | キャッシュ                   |                    |
| `fetch options.cache`           |                             |                              | キャッシュまたはオプトアウト |                    |
| `fetch options.next.revalidate` |                             | 再検証                       | 再検証                       |                    |
| `fetch options.next.tags`       |                             | キャッシュ                   | キャッシュ                   |                    |
| `revalidateTag`                 | 再検証 (サーバーアクション) | 再検証                       | 再検証                       |                    |
| `revalidatePath`                | 再検証 (サーバーアクション) | 再検証                       | 再検証                       |                    |
| `const revalidate`              |                             | 再検証またはオプトアウト     | 再検証またはオプトアウト     |                    |
| `const dynamic`                 |                             | キャッシュまたはオプトアウト | キャッシュまたはオプトアウト |                    |
| `cookies`                       | 再検証 (サーバーアクション) |                              |                              |                    |
| `headers、searchParams`         |                             |                              | 身を引く                     |                    |
| `generateStaticParams`          |                             | キャッシュ                   |                              |                    |
| `React.cache`                   |                             |                              |                              | キャッシュ         |
| `unstable_cache`                |                             |                              |                              |                    |
